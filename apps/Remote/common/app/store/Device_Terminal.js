/*
 * File: app/store/Device_Terminal.js
 *
 * This file was generated by Sencha Architect
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Sencha Touch 2.4.x library, under independent license.
 * License of Sencha Architect does not include license for Sencha Touch 2.4.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('HelcRemote.store.Device_Terminal', {
    extend: 'Ext.data.Store',

    requires: [
        'Ext.data.proxy.JsonP',
        'Ext.data.reader.Json',
        'Ext.data.Field'
    ],

    config: {
        storeId: 'Device_Terminal',
        proxy: {
            type: 'jsonp',
            reader: {
                type: 'json',
                rootProperty: 'data'
            }
        },
        listeners: [
            {
                fn: 'onJsonpstoreBeforeLoad',
                event: 'beforeload'
            },
            {
                fn: 'onJsonpstoreLoad',
                event: 'load'
            }
        ],
        fields: [
            {
                name: 'id'
            },
            {
                name: 'mallId'
            },
            {
                name: 'mallName'
            },
            {
                name: 'templateId'
            },
            {
                name: 'templateName'
            },
            {
                name: 'floor'
            },
            {
                name: 'floorName'
            },
            {
                name: 'position'
            },
            {
                name: 'testEngine'
            },
            {
                name: 'remark'
            },
            {
                name: 'serial'
            },
            {
                name: 'angle'
            },
            {
                name: 'advTimes'
            },
            {
                name: 'ipaddress'
            },
            {
                name: 'heartbeatstr'
            },
            {
                name: 'heartbeattime'
            },
            {
                name: 'terSize'
            },
            {
                name: 'resolution'
            },
            {
                name: 'alarmTime'
            },
            {
                name: 'alarmData'
            },
            {
                name: 'alarms'
            }
        ]
    },

    onJsonpstoreBeforeLoad: function(store, operation, eOpts) {
        var url = 'http://' + remote.getCmsIP() + '/YL_SCDG/business/terminal/terminalforipad.do';
        // url = url + '?type=' + this.parm;
        store.getProxy().setUrl(url);
    },

    onJsonpstoreLoad: function(store, records, successful, operation, eOpts) {
        store.checkAlarms();
    },

    loadDat: function(onSuccess, onFailure, parm) {
        // 设置-屏幕
        var me = this;
        this.onSuccess = onSuccess;

        if(global.isWorklight()) {
            me.parm = parm;
            me.load();
        } else {
            this.setData([{
        		"id": 12,
        		"mallId": 0,
        		"mallName": "科学城",
        		"templateId": 0,
        		"templateName": "203",
        		"floor": 0,
        		"floorName": "2F",
        		"position": "0,0",
        		"testEngine": 0,
        		"remark": "2-3,J墙",
        		"serial": "2003",
        		"angle": 0.0,
        		"advTimes": 0,
        		"ipaddress": "10.98.194.24",
        		"heartbeatstr": "CPU26%  硬盘45%  内存37%",
        		"heartbeattime": "2016-12-12 10:25:01",
        		"terSize": "49",
        		"resolution": "3840,2160"
        	}, {
        		"id": 13,
        		"mallId": 0,
        		"mallName": "科学城",
        		"templateId": 0,
        		"templateName": "204",
        		"floor": 0,
        		"floorName": "2F",
        		"position": "0,0",
        		"testEngine": 0,
        		"remark": "2-4,K",
        		"serial": "2004",
        		"angle": 0.0,
        		"advTimes": 0,
        		"ipaddress": "10.98.194.132",
        		"heartbeatstr": "CPU15%  硬盘67%  内存39%",
        		"heartbeattime": "2016-11-16 14:43:15",
        		"terSize": "49",
        		"resolution": "3840,2160"
        	}, {
        		"id": 15,
        		"mallId": 0,
        		"mallName": "科学城",
        		"templateId": 0,
        		"templateName": "206",
        		"floor": 0,
        		"floorName": "2F",
        		"position": "0,0",
        		"testEngine": 0,
        		"remark": "2-6,O",
        		"serial": "2006",
        		"angle": 0.0,
        		"advTimes": 0,
        		"ipaddress": "10.98.194.26",
        		"heartbeatstr": "CPU16%  硬盘89%  内存43%",
        		"heartbeattime": "2016-12-12 10:25:41",
        		"terSize": "49",
        		"resolution": "3820,2160"
        	}, {
        		"id": 16,
        		"mallId": 0,
        		"mallName": "科学城",
        		"templateId": 0,
        		"templateName": "207",
        		"floor": 0,
        		"floorName": "2F",
        		"position": "0,0",
        		"testEngine": 0,
        		"remark": "2-7,P1",
        		"serial": "2007",
        		"angle": 0.0,
        		"advTimes": 0,
        		"ipaddress": "10.98.194.27",
        		"heartbeatstr": "CPU90%  硬盘38%  内存42%",
        		"heartbeattime": "2016-11-16 14:41:16",
        		"terSize": "49",
        		"resolution": "3820,2160"
        	}]);
            this.checkAlarms();
        }
    },

    checkAlarms: function(callback) {
        var now = new Date();
        var ALARM_COLOR = '#ffaaaa';
        this.each(function(record){
            // 心跳超时警告
            var t = new Date(Date.parse(record.get('heartbeattime').replace(/-/g, '/')));
            var diff = Ext.Date.diff(t, now, Ext.Date.MINUTE);
            record.set('alarmTime', diff>5? ALARM_COLOR:'');
        //     console.log(diff);

            // 心跳数据超标
            var data = record.get('heartbeatstr').replace(/CPU/,'').replace(/硬盘/,'').replace(/内存/,'').split('%');
            record.set('alarmData', data[0]>=85||data[1]>=85||data[2]>=85? ALARM_COLOR:'');

            record.set('alarms', record.get('alarmTime')!==''||record.get('alarmData')!==''?
                       '<i class="fa fa-exclamation-triangle"></i>':'&nbsp;');
        });
        this.onSuccess();
    }

});